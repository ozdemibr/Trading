//@version=4
study("MACD Linear Regression by zdmre", "MACD Linear Regression",false)
fastLength = input(12, minval=1)
slowLength = input(26,minval=1)
signalLength=input(9,minval=1)
hline(0, '0 Line', linewidth=1, color=color.white)
fastMA = ema(close, fastLength)
slowMA = ema(close, slowLength)
macd = fastMA - slowMA
signal = sma(macd, signalLength)
plot(crossover(macd, signal) ? signal : na, title='CrossUp', style=plot.style_cross, color=#15c300, linewidth=5)
plot(crossunder(macd, signal) ? signal : na, title='CrossDown', style=plot.style_cross, color=#ed0000, linewidth=5)
macd_colorChange = input(true,title="Change MACD Line Color-Signal Line Cross?")
showhist = input(true, title="Show Histogram?")
hist_colorChange = input(true,title="MACD Histogram 4 Colors?")
macd_IsAbove = macd >= signal
macd_IsBelow = macd < signal
macd_color = macd_colorChange ? macd_IsAbove ? color.yellow : color.red : color.red
signal_color = macd_colorChange ? macd_IsAbove ? color.blue : color.blue : color.lime
hist = macd - signal
histAIsUp = hist > hist[1] and hist > 0
histAIsDown = hist < hist[1] and hist > 0
histBIsDown = hist < hist[1] and hist <= 0
histBIsUp = hist > hist[1] and hist <= 0
plot_color = hist_colorChange ? histAIsUp ? color.aqua : histAIsDown ? color.blue : histBIsDown ? color.red : histBIsUp ? color.maroon :color.yellow :color.gray
plot(signal, color=signal_color, title="SIGNAL")
plot(macd, color=macd_color, title="MACD", linewidth=2)
plot(showhist and hist ? hist : na, title="Histogram", color=plot_color, style=plot.style_histogram, linewidth=4)
drawLine(X1, Y1, X2, Y2, ExtendType, Color, LineStyle) => var line Line = na, Line := line.new(X1, Y1, X2, Y2, xloc.bar_index, ExtendType, Color, LineStyle, 1), line.delete(Line[1])
rsdcr2(PeriodMinusOne, Deviations, Estimate) => 
    var period = PeriodMinusOne + 1, var devDenominator = Estimate=="Unbiased" ? PeriodMinusOne : period, Ex = 0.0, Ex2 = 0.0, Exy = 0.0, Ey = 0.0, for i=0 to PeriodMinusOne
        closeI = nz(macd[i]), Ex := Ex + i, Ex2 := Ex2 + i * i, Exy := Exy + closeI * i, Ey := Ey + closeI
    ExEx = Ex * Ex, slope = Ex2==ExEx ? 0.0 : (period * Exy - Ex * Ey) / (period * Ex2 - ExEx), linearRegression = (Ey - slope * Ex) / period, intercept = linearRegression + bar_index * slope, deviation = 0.0, for i=0 to PeriodMinusOne
        deviation := deviation + pow(nz(macd[i]) - (intercept - bar_index[i] * slope), 2.0)
    deviation := Deviations * sqrt(deviation / devDenominator), correlate = correlation(macd, bar_index, period), r2 = pow(correlate, 2.0), [linearRegression, slope, deviation, correlate, r2]
periodTrend    = input(89,  "Trend Period", input.integer,  minval=  4)
deviationsAmnt = input(1.5, " Deviation", input.float  ,  minval=0.1, step=0.1)
estimatorType  = input("Unbiased",    " Estimator", input.string , options=["Biased","Unbiased"])
var extendType = input("Right", "Extend", input.string , options=[ "Right","Segment" ])=="Right" ? extend.right : extend.none
periodMinusOne = periodTrend - 1
[linReg, slope, deviation, correlate, r2] = rsdcr2(periodMinusOne, deviationsAmnt, estimatorType)
endPointBar = bar_index - periodTrend + 1, endPointY = linReg + slope * periodMinusOne
drawLine(endPointBar, endPointY + deviation, bar_index, linReg + deviation, extendType, color.red, line.style_solid )
drawLine(endPointBar, endPointY            , bar_index, linReg            , extendType, #CCCC00ff, line.style_dotted)
drawLine(endPointBar, endPointY - deviation, bar_index, linReg - deviation, extendType, color.green, line.style_solid )
var label Label = na, Label := label.new(max(0, endPointBar), endPointY, text=tostring(correlate, "#.####"), color=0.0>correlate ? color.red : color.green, textcolor=#FFFFFFff, style=label.style_label_right, tooltip="Correlation: " + tostring(correlate) + "\nR2: " + tostring(r2)), label.delete(Label[1]) 
